<!DOCTYPE html>
<html>
    <head>
        <title>Stream Graph</title>
        <meta charset="utf-8"><style>

            body {
                font: 10px sans-serif;
            }

            .chart { 
                background: #fff;
            }

            p {
                font: 12px helvetica;
            }


            .axis path, .axis line {
                fill: none;
                stroke: #000;
                stroke-width: 2px;
                shape-rendering: crispEdges;
            }

            button {
                position: absolute;
                right: 50px;
                top: 10px;
            }

        </style>
    </head>
    <body>
        
        <script src="https://d3js.org/d3.v4.min.js"></script>

        <script>

            chart("stressData2.csv");

            var datearray = [];
            var colorrange = [];


            function chart(csvpath) {

                colorRange = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
                strokeColor = colorRange[0];

                var format = d3.timeParse("%H:%M:%S");
                var margin = {top: 20, right: 40, bottom: 30, left: 30};
                var width = 900 - margin.left - margin.right;
                var height = 400 - margin.top - margin.bottom;

                var svg = d3.select("body")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                
                var x = d3.scaleTime()
                        .range([0, width]);

                var y = d3.scaleLinear()
                        .range([height - 10, 0]);

                var z = d3.scaleOrdinal()
                        .range(colorRange);
                
                var tooltip = d3.select("body")
                        .append("div")
                        .attr("class", "remove")
                        .style("position", "absolute")
                        .style("z-index", "20")
                        .style("visibility", "hidden")
                        .style("top", "30px")
                        .style("left", "55px");

                var stack = d3.stack();
                
                d3.csv(fileName, type, function (data) {
                    if (error) throw error;
                    
                    x.domain(d3.extent(data, function (d) {
                        return d.date;
                    }));
                    
                    y.domain([0, d3.max(data, function (d) {
                        return d.y0 + d.y;
                    })]);
                    
                    
                svg.selectAll(".layer")
                            .data(layers)
                            .enter().append("path")
                            .attr("class", "layer")
                            .attr("d", function (d) {
                                return area(d.values);
                            })
                            .style("fill", function (d, i) {
                                return z(i);
                            });


                    svg.append("g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            .call(xAxis);

                    svg.append("g")
                            .attr("class", "y axis")
                            .attr("transform", "translate(" + width + ", 0)")
                            .call(yAxisr);

                    svg.append("g")
                            .attr("class", "y axis")
                            .call(yAxis);

                    svg.selectAll(".layer")
                            .attr("opacity", 1)
                            .on("mouseover", function (d, i) {
                                svg.selectAll(".layer").transition()
                                        .duration(250)
                                        .attr("opacity", function (d, j) {
                                            return j != i ? 0.6 : 1;
                                        })
                            })

                            .on("mousemove", function (d, i) {
                                mousex = d3.mouse(this);
                                mousex = mousex[0];
                                var invertedx = x.invert(mousex);
                                invertedx = invertedx.getMonth() + invertedx.getDate();
                                var selected = (d.values);
                                for (var k = 0; k < selected.length; k++) {
                                    datearray[k] = selected[k].date
                                    datearray[k] = datearray[k].getMonth() + datearray[k].getDate();
                                }

                                mousedate = datearray.indexOf(invertedx);
                                pro = d.values[mousedate].value;

                                d3.select(this)
                                        .classed("hover", true)
                                        .attr("stroke", strokecolor)
                                        .attr("stroke-width", "0.5px"),
                                        tooltip.html("<p>" + d.key + "<br>" + pro + "</p>").style("visibility", "visible");

                            })
                            .on("mouseout", function (d, i) {
                                svg.selectAll(".layer")
                                        .transition()
                                        .duration(250)
                                        .attr("opacity", "1");
                                d3.select(this)
                                        .classed("hover", false)
                                        .attr("stroke-width", "0px"), tooltip.html("<p>" + d.key + "<br>" + pro + "</p>").style("visibility", "hidden");
                            })
                            
                d3.select("svg")
                            .on("mousemove", function () {
                                mousex = d3.mouse(this);
                                mousex = mousex[0] + 5;
                                vertical.style("left", mousex + "px")
                            })
                            .on("mouseover", function () {
                                mousex = d3.mouse(this);
                                mousex = mousex[0] + 5;
                                vertical.style("left", mousex + "px")
                            });
                            
                        .offset(d3.stackOffsetSilhouette)
                        .keys(function (d) {
                            return d.date;
                        })
                        

                
            var xAxis = d3.axisBottom()
                        .scale(x)
                        .ticks(d3.timeWeek);

                var yAxis = d3.axisLeft()
                        .scale(y);

                var yAxisr = d3.axisRight()
                        .scale(y);

                

                var nest = d3.nest()
                        .key(function (d) {
                            return d.key;
                        });

                var area = d3.area()
                        .curve(d3.curveCardinal)
                        .x(function (d) {
                            return x(d.date);
                        })
                        .y0(function (d) {
                            return y(d.y0);
                        })
                        .y1(function (d) {
                            return y(d.y0 + d.y);
                        });

                


                    var layers = stack(nest.entries(data));

                    

                    

                    var vertical = d3.select(".chart")
                            .append("div")
                            .attr("class", "remove")
                            .style("position", "absolute")
                            .style("z-index", "19")
                            .style("width", "1px")
                            .style("height", "380px")
                            .style("top", "10px")
                            .style("bottom", "30px")
                            .style("left", "0px")
                            .style("background", "#fff");

                    
                });
            }
            function type(d) {
                d.value = +d.value;
                d.date = format(d.date);
                return d;
            }
        </script>
    </body>
</html>